# Little C Compiler

*Please read docs for a more detailed reference*

"LittleC" is a C-language compiler originally written in the early 2000s by Simon Lehmayr (https://www.simon-lehmayr.de/), 
for the SC61860 CPU, used in several Sharp Pocket Computers, like:

PC-1360, PC-1350, PC-1475, PC-1450, PC-1401, PC-1402, PC-1403, PC-1403H, PC-1421, PC-1260, PC-1261

The C language supported by LittleC is not compliant to the full ANSI-C standard. 
Features and limitations are reported in `Docs/littleC manual.txt`. Note that, some bugs might still be present, 
and not all unsupported features are checked during compilation, so beware!

The compiler is composed of three distinct tools: `lcpp` (C pre-compiler), `lcc` (C-to-ASM compiler) and `pasm` (ASM-to-binary compiler), but 
these are wrapped for simplicity into a `make.bat` (MS-DOS batch) file.

For example, to compile `Demos\parameters\main.c` and generate POKE instructions ready to be embedded in a BASIC program, 
in a Windows `cmd` shell, from within the `lcc_b1` dir (home to LittleC tools), enter:

```
 > make.bat Demos\parameters\main.c tmp.bas bas
 > more tmp.bas
10 POKE 57392,128,16,224,66,0,11,25,120,224,175,128,16,224,66,0,11,24,55,0
20 POKE 57411,0,0,0,0,0,0,0,0,0,0,0,34,116,2,48,89,218,80,89,55,34,116,22
30 POKE 57434,48,89,218,80,89,52,218,52,120,224,78,128,219,34,116,2,50,219
...
```

I'm publishing LittleC here on github (including its source code - see below), hoping someone else might find this project interesting enough to improve it even more.

What's mostly missing at present is an, even basic, set of standard libraries for keyboard input and screen output handling...

## Debugging with MAME

MAME (https://www.mamedev.org/ - a freeware general purpose machine emulator) could be used for early debugging of programs, 
as it offers convenient step-tracing features. Refer to the MAME manuals for furhter info.
Unfortunately, Sharp PC ROM and artwork can be found for the PC-1403 model only.

Other emulators offer a much larger set of supported models (see https://pockemul.com/), 
but at the moment they don't offer a machine language debugging feature.

With MAME, after a binary output `tmp.bin` (default option) has been generated by LittleC:

```
 > make [...]\main.c tmp.bin
```

copy the binary file onto the MAME root:

```
 > copy tmp.bin ..\mame
```

Then (preferably from a different `cmd` window), start MAME in debug mode:

```
 > cd [...]\mame
 > mame pc1403 -debug -nomaximize
```

which will open a debugger window, along with the Sharp PC emulation window.

*NOTE* - Sometimes the emulated machine doesn't start up properly. It just doesn't respond to the keyboard!
Use the `soft reset` menu command, from MAME debugger window, until you get:

```
 MEMORY ALL CLEAR O.K.?
```

on the emulated Sharp PC screen, then give <Enter> to confirm the device reset.

We need to reserve some memory to store our machine code. Detailed instructions differ for each Sharp PC model 
and are provided in the `Docs/littleC manual.txt`.

E.g. to reserve 2Kb on the PC-1403, the following should be done, before uploading the binary in the device memory.

Set the emulated Sharp PC in BASIC <PRO> mode, then enter:

```
 NEW
 MEM
 > 6878
 POKE &FF01,&30,&E8
 NEW
 MEM
 > 4830
```

The machine code entry point is set at `0xE030 = 57576`, at the beginning of the `main.c` program:

```
#org 0xE030

...
```

hence you can prepare a Sharp BASIC program to call the machine language program, with a CALL like:

```
10 CALL &E030
```

Then, in the MAME debugger console window, enter the command to load the binary in the emulator memory:

```
 load tmp.bin,e030:maincpu
```
 
If you want to set a breakpoint, for example at the program entry point, 
in the MAME debugger console enter the "breakpoint set" command:

```
 bps e030
```

Back to the emulated PC-1403, in BASIC <RUN> start the program 

```
RUN
```

and MAME debugger will stop at the breakpoint, if set, where you can start your tests from. The 'Enter' key will move step-by-step.
The debugger has the usual 'step' and 'run' commands accessed by the debugger window menu. CPU registries are shown. The internal SC61860 CPU RAM (addresses starting at `0x0000`) can be shown opening a new debugger memory window and selecting the one tagged with `Sharp SC61860 :maincpu/0/m_ram`.

For each new test cycle, rebuild the binary, load it on MAME and restart:

```
 (cmd)> make [...]\main.c tmp.bin
 (cmd)> copy tmp.bin ..\mame
 (debugger) load tmp.bin,e030:maincpu
 (debugger) 'soft reset' (repeat, if device is not responding)
 (Sharp PC) <PRO> mode
 (Sharp PC) RUN
```

No need to reenter the POKE or the BASIC program, as MAME soft reset won't wipe memory out.

## Compiler source code and rebuild

The LittleC version found on present github repo (the source code was published as freeware by the author, on its page), 
and it was sligthly upgraded and revised, to fix some bugs. Also it has a -still *tentative*-, early implementation
for floating-point variables. Unfortunately, ROMs differ among different PC models, 
and I have found some partial documentation for floating-point operation for the PC-1403 only.

The compiler source code was written in Pascal, originally for the TurboPascal I think,
but the version on this repo has been ported to modern free Pascal IDE: Lazarus (https://www.lazarus-ide.org/),
at the expense of getting larger executables, compared to Simon's original ones. On the other hand, TurboPascal isn't for free.

Code has been imported using the Lazarus standard import tool, and the generation of new executables went fine at first try.

In order to build a new executable, for example the `lcc.exe`, you should (assuming Lazarus has already been installed):

* double click on the `Source/lcc/lcc.lpi` file (this will launch the Lazarus IDE)
* Exec - Compile (ctrl-F9) menu

which will produce a message, if successful, including the destination of the newly built executable. 
You should then copy this executable to the main `lcc_b1` dir, so that it can be used by the `make` batch:

With the aim of reducing executable size, the following Lazarus compiler options could be set, 
from the 'Project - Project Options - Compiler Options' menu: 

* Configuration and Target:
  * Destination OS: Win32
  * CPU Family Destinatio: i386

* Compilation and link
  * Optimization: O3 (slow optimization)
  * Other: rather smaller than faster
 
but this needs first the installation of the 64-to-32bit cross-compiler extension (`lazarus-3.4-fpc-3.2.2-cross-i386-win32-win64.exe`).
However, this isn't necessary because the executable size isn't a significant issue.
